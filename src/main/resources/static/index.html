<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>CRUD Properties</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <div class="header">
      <h1> Properties Manager</h1>
    </div>
    
    <div class="content">
      <div class="form-section">
        <h2>Add New Property</h2>
        <form id="propForm">
          <div class="form-grid">
            <div class="form-group">
              <label for="address">Address</label>
              <input name="address" id="address" placeholder="Enter property address" required />
            </div>
            <div class="form-group">
              <label for="price">Price ($)</label>
              <input name="price" id="price" type="number" step="0.01" placeholder="0.00" required />
            </div>
            <div class="form-group">
              <label for="size">Size (m²)</label>
              <input name="size" id="size" type="number" placeholder="0" required />
            </div>
            <div class="form-group full-width">
              <label for="description">Description</label>
              <input name="description" id="description" placeholder="Property description (optional)" />
            </div>
          </div>
          <div class="button-group">
            <button type="submit" class="btn btn-primary">Create Property</button>
            <button type="button" id="cancelEdit" class="btn btn-secondary" style="display:none;">Cancel Edit</button>
          </div>
        </form>
      </div>

      <div class="properties-section">
        <h2>Property List</h2>
        <ul id="list" class="property-list"></ul>
      </div>
    </div>
  </div>

  <script>
    const API = '/api/properties';
    let editId = null; // id del property que estamos editando

    async function fetchAll(){
      const res = await fetch(API);
      const data = await res.json();
      const ul = document.getElementById('list');
      ul.innerHTML = '';
      
      if (data.length === 0) {
        ul.innerHTML = '<div class="empty-state">No properties found. Add your first property above!</div>';
        return;
      }
      
      data.forEach(p => {
        const li = document.createElement('li');
        li.className = 'property-item';
        
        li.innerHTML = `
          <div class="property-info">
            <div class="property-address">${p.address}</div>
            <div class="property-price">$${p.price.toLocaleString()}</div>
            <div class="property-size">${p.size} m²</div>
          </div>
          ${p.description ? `<div class="property-description">${p.description}</div>` : ''}
          <div class="property-actions">
            <button class="btn-edit" onclick="startEdit(${JSON.stringify(p).replace(/"/g, '&quot;')})"> Edit</button>
            <button class="btn-delete" onclick="deleteProperty(${p.id})"> Delete</button>
          </div>
        `;
        
        ul.appendChild(li);
      });
    }

    async function deleteProperty(id) {
      if (confirm('Are you sure you want to delete this property?')) {
        await fetch(`${API}/${id}`, {method:'DELETE'}); 
        fetchAll(); 
      }
    }

    function startEdit(p){
      const f = document.getElementById('propForm');
      f.address.value = p.address;
      f.price.value = p.price;
      f.size.value = p.size;
      f.description.value = p.description || '';
      editId = p.id;

      f.querySelector("button[type=submit]").textContent = "Update Property";
      f.querySelector("button[type=submit]").className = "btn btn-primary";
      document.getElementById("cancelEdit").style.display = "inline-block";
      
      document.querySelector('.form-section').scrollIntoView({ behavior: 'smooth' });
    }

    function resetForm(){
      const f = document.getElementById('propForm');
      f.reset();
      f.querySelector("button[type=submit]").textContent = "Create Property";
      f.querySelector("button[type=submit]").className = "btn btn-primary";
      document.getElementById("cancelEdit").style.display = "none";
      editId = null;
    }

    document.getElementById("cancelEdit").onclick = resetForm;

    document.getElementById('propForm').onsubmit = async (e) => {
      e.preventDefault();
      const f = e.target;
      const body = {
        address: f.address.value,
        price: parseFloat(f.price.value),
        size: parseInt(f.size.value),
        description: f.description.value
      };

      try {
        if(editId){ // si estamos editando
          await fetch(`${API}/${editId}`, { 
            method:'PUT', 
            headers:{'Content-Type':'application/json'}, 
            body: JSON.stringify(body) 
          });
        } else { // creando
          await fetch(API, { 
            method:'POST', 
            headers:{'Content-Type':'application/json'}, 
            body: JSON.stringify(body) 
          });
        }
        resetForm();
        fetchAll();
      } catch (error) {
        alert('Error saving property. Please try again.');
        console.error('Error:', error);
      }
    };

    // Initialize
    fetchAll();
  </script>
</body>
</html>
